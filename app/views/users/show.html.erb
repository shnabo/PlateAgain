<script src="//maps.google.com/maps/api/js?key=AIzaSyANACUqN0_0EnKIBM8awdCsbpEkfrs1QXo"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script>

<h1><%= @user.name %></h1>

<% if @user.photo.present? %>
  <%= image_tag @user.photo.url %>
<% end %>

<p>Address: <%= @user.full_street_address %></p>
<p>Phone: <%= @user.phone %></p>
<p>Email: <%= @user.email %></p>
<p>Website: <%= @user.homepage %></p>
<p><%= @user.description %></p>

<div id="address"></div>
<div style='width: 800px;'>
  <div id="basic_map" style='width: 800px; height: 400px;'></div>
</div>
<script> handler = Gmaps.build('Google');
handler.buildMap({ internal: {id: 'basic_map' }});</script>
<script>

$(function(){

	var mapStyle = [{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#444444"}]},{"featureType":"administrative.country","elementType":"geometry.fill","stylers":[{"visibility":"on"}]},{"featureType":"administrative.province","elementType":"labels.icon","stylers":[{"hue":"#ff0000"},{"visibility":"on"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2f2f2"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#46bcec"},{"visibility":"on"}]}];

	var directionsDisplay = new google.maps.DirectionsRenderer();
	var directionsService = new google.maps.DirectionsService();
	var currgeocoder;

	navigator.geolocation.getCurrentPosition(function(position, html5Error) {
	     geo_loc = processGeolocationResult(position);
	     currLatLong = geo_loc.split(",");
	     initializeCurrent(currLatLong[0], currLatLong[1]);
	     users_latitude = currLatLong[0];
	     users_longitude = currLatLong[1];
	});

	//Get geo location result
	function processGeolocationResult(position) {
	     html5Lat = position.coords.latitude; //Get latitude
	     html5Lon = position.coords.longitude; //Get longitude
	     html5TimeStamp = position.timestamp; //Get timestamp
	     html5Accuracy = position.coords.accuracy; //Get accuracy in meters
	     return (html5Lat).toFixed(8) + ", " + (html5Lon).toFixed(8);
	}

	//Check value is present or not & call google api function
	function initializeCurrent(latcurr, longcurr) {
	     currgeocoder = new google.maps.Geocoder();
	     console.log(latcurr + "-- ######## --" + longcurr);

	     users_latitude_on_map = latcurr;
		 users_longitude_on_map = longcurr;

	     if (latcurr != '' && longcurr != '') {
	         var myLatlng = new google.maps.LatLng(latcurr, longcurr);
	         return getCurrentAddress(myLatlng);
	     }
	}

	//Get current address
	function getCurrentAddress(location) {
		currgeocoder.geocode({
			'location': location
		}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				$("#address").html(results[0].formatted_address);
				users_location_on_map = results[0].formatted_address;
				return users_location_on_map;
			} else {
				alert('Geocode was not successful for the following reason: ' + status);
			}
		});
	}

	var myDivObj;
	setTimeout(function() {
		myDivObj = $('#address').text();
		function calcRoute() {
		  var origin = myDivObj;
		  var destination = new google.maps.LatLng("<%= @user.latitude %>", "<%= @user.longitude %>");
		  var request = {
		      origin:      origin,
		      destination: destination,
		      travelMode:  google.maps.TravelMode.WALKING
		  };
		  directionsService.route(request, function(response, status) {
		    if (status == google.maps.DirectionsStatus.OK) {
		      directionsDisplay.setDirections(response);
		    }
		  });
		}
		calcRoute();
	}, 5000);


	var handler = Gmaps.build('Google');
	handler.buildMap({ provider: {mapTypeId: google.maps.MapTypeId.ROADMAP, styles: mapStyle}, internal: {id: 'custom_style'}}, function(){
	  	directionsDisplay.setMap(handler.getMap());
	});
});

</script>
